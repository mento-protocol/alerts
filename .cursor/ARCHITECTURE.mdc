---
globs: *.tf
alwaysApply: false
---
# Terraform Architecture

## Modular Design

This Terraform configuration follows a modular architecture with clear separation between different monitoring systems:

```plain
terraform/
â”œâ”€â”€ main.tf                # Root module - providers and module orchestration
â”œâ”€â”€ variables.tf           # Shared variables across modules
â”œâ”€â”€ outputs.tf             # Aggregated outputs from modules
â”œâ”€â”€ terraform.tfvars.example  # Example configuration
â”‚
â”œâ”€â”€ discord-monitoring.tf  # Shared Discord infrastructure (channels & webhooks)
â”œâ”€â”€ safe-event-signatures.md  # Event signatures reference (provider-agnostic)
â”‚
â”œâ”€â”€ sentry-alerts/         # Sentry error monitoring module
â”‚   â”œâ”€â”€ main.tf            # Sentry resources
â”‚   â”œâ”€â”€ providers.tf       # Provider requirements
â”‚   â”œâ”€â”€ variables.tf       # Module inputs
â”‚   â””â”€â”€ outputs.tf         # Module outputs
â”‚
â””â”€â”€ tenderly-alerts-archived/  # ARCHIVED: Tenderly blockchain monitoring
    â”œâ”€â”€ README.md              # Why archived & reactivation guide
    â”œâ”€â”€ module/                # Complete Tenderly module (preserved)
    â”œâ”€â”€ docs/                  # Setup documentation
    â”œâ”€â”€ config-snippets/       # Configuration templates
    â””â”€â”€ example-configs/       # Example configurations
```

## Current State

- **Active**: Sentry error monitoring + Discord infrastructure
- **Planned**: QuickNode Webhooks for blockchain event monitoring
- **Archived**: Tenderly integration (due to pricing)

## Design Principles

### 1. Module Independence

Each module is self-contained with its own:

- Resource definitions
- Variable declarations
- Output values
- Provider requirements

Benefits:

- Deploy/destroy modules independently
- Test modules in isolation
- Reuse modules in other projects
- Clear ownership boundaries

### 2. Provider Management

All provider **configurations** are in the root `main.tf`:

```hcl
# Root main.tf
provider "discord" { ... }
provider "sentry" { ... }
provider "restapi" { alias = "discord" ... }
```

Modules declare **requirements** in `providers.tf`:

```hcl
# Module providers.tf
terraform {
  required_providers {
    discord = { ... }
  }
}
```

This pattern:

- Centralizes authentication
- Prevents duplicate providers
- Allows provider version management
- Enables provider aliasing

### 3. Variable Flow

```plain
terraform.tfvars
    â†“
root variables.tf
    â†“
module blocks in main.tf
    â†“
module variables.tf
```

Shared variables (like `discord_server_id`) are:

1. Declared in root `variables.tf`
2. Passed to modules in `main.tf`
3. Received in module `variables.tf`

### 4. Output Aggregation

Module outputs flow up:

```plain
module outputs.tf
    â†“
root main.tf (module.name.output)
    â†“
root outputs.tf
```

This allows:

- Module encapsulation
- Selective output exposure
- Combined summaries

## Module Details

```plain
Application Errors â†’ Sentry â†’ Discord Channels
Blockchain Events â†’ QuickNode (planned) â†’ Discord Webhooks â†’ Discord Channels
```

### Sentry Alerts Module

**Purpose**: Monitor application errors

**Resources**:

- Sentry project discovery
- Discord channel creation
- Alert rule configuration
- Permission management

**Dependencies**:

- Sentry provider
- Discord provider

### Discord Monitoring Infrastructure

**Purpose**: Shared Discord channels and webhooks for blockchain monitoring

**Location**: `discord-monitoring.tf` (root level)

**Resources**:

- Discord channel creation (2 per multisig)
  - `#ðŸš¨ï¸±multisig-alerts-{name}` - Critical events
  - `#ðŸ””ï¸±multisig-events-{name}` - Normal events
- Discord webhook creation (automated via REST API)

**Provider-agnostic**: Can be used with any blockchain monitoring service

### Archived: Tenderly Alerts Module

**Status**: Fully developed but not deployed due to pricing

**Location**: `tenderly-alerts-archived/`

**Features**:

- 16 Safe event types monitored per multisig
- Automatic contract registration
- Discord integration
- Complete documentation

**Reactivation**: See `tenderly-alerts-archived/README.md`

## Key Features

### 1. Automated Discord Webhooks

The Discord infrastructure automatically creates webhooks:

```hcl
# discord-monitoring.tf
resource "restapi_object" "discord_webhook_alerts" {
  provider = restapi.discord  # Uses aliased provider
  ...
}
```

Benefits:

- Zero manual steps
- Consistent configuration
- Terraform state management
- Provider-agnostic naming

### 2. Dynamic Resource Creation

Both active components use `for_each` for dynamic scaling:

```hcl
# Create resources for each project/multisig
resource "discord_text_channel" "multisig_alerts" {
  for_each = local.multisigs
  ...
}
```

### 3. Event Mapping

Safe event signatures are documented in `safe-event-signatures.md`:

- Uses Foundry's `cast` tool for signature generation
- 16 event types categorized by security impact
- Provider-agnostic reference

## Best Practices

### 1. Module Changes

When modifying a module:

1. Change only files within the module directory
2. Run targeted apply: `terraform apply -target=module.module_name`
3. Test outputs before full deployment

### 2. Adding New Blockchain Monitoring

To add QuickNode or another provider:

1. Use existing Discord infrastructure in `discord-monitoring.tf`
2. Create new module directory (e.g., `quicknode-alerts/`)
3. Reference webhook URLs from `multisig_webhook_urls` output
4. Follow modular patterns from archived Tenderly module

### 3. Provider Updates

To update provider versions:

1. Modify root `main.tf` provider requirements
2. Run `terraform init -upgrade`
3. Test with `terraform plan`

### 4. Variable Management

- Sensitive variables: Mark with `sensitive = true`
- Default values: Provide sensible defaults in module variables
- Required values: Document in module README

## Module Communication

Modules don't directly communicate. Data flow:

1. **Shared Infrastructure**: Discord channels/webhooks in root
2. **Provider Sharing**: Root module passes configured providers
3. **Variable Sharing**: Common variables passed to modules
4. **Output Aggregation**: Root module combines outputs

## Migration Path

### From Tenderly to QuickNode

1. Discord infrastructure remains unchanged
2. Webhook URLs are already provider-agnostic
3. Create `quicknode-alerts/` module
4. Use webhook URLs from `multisig_webhook_urls` output
5. Reference `safe-event-signatures.md` for events

### Reactivating Tenderly

1. Copy configuration snippets from archive
2. Update module source path
3. Uncomment variables in `terraform.tfvars`
4. Run `terraform init && terraform apply`

## Security

### Sensitive Data

- API keys: Stored in `terraform.tfvars` (gitignored)
- Webhook URLs: Marked as sensitive outputs
- Bot tokens: Never logged (sensitive = true)

### State Management

- Local state: Contains sensitive values
- Remote state: Use encryption
- State access: Limit to necessary users

## Testing Strategy

### Module Testing

```bash
# Test individual module
cd sentry-alerts
terraform init
terraform validate
```

### Integration Testing

```bash
# Test full deployment
terraform plan

# Deploy Sentry monitoring
terraform apply -target=module.sentry_alerts

# Deploy Discord infrastructure
terraform apply -target=discord_text_channel.multisig_alerts \
                -target=discord_text_channel.multisig_events \
                -target=restapi_object.discord_webhook_alerts \
                -target=restapi_object.discord_webhook_events
```

### Cleanup Testing

```bash
# Test destroy order
terraform destroy -target=restapi_object.discord_webhook_alerts
terraform destroy -target=restapi_object.discord_webhook_events
terraform destroy -target=discord_text_channel.multisig_alerts
terraform destroy -target=discord_text_channel.multisig_events
terraform destroy -target=module.sentry_alerts
```

## Future Considerations

### Adding QuickNode

1. Create `quicknode-alerts/` module
2. Use existing Discord webhooks
3. Implement event filtering based on `safe-event-signatures.md`
4. Follow Tenderly module patterns for consistency

### Scaling Multisigs

1. Add to `multisigs` variable
2. Discord channels/webhooks automatically created
3. Update monitoring provider configuration

### Cost Optimization

- Discord: Free (bot + webhooks)
- Sentry: Within free tier limits
- QuickNode: More cost-effective than Tenderly for alerts
- Infrastructure: Minimal (channels + webhooks only)